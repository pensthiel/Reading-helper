<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reading Helper</title>
<style>
  body { font-family: sans-serif; background: #fafafa; margin: 0; padding: 0; }
  header { padding: 1em; background: #4a90e2; color: white; }
  main { padding: 1em; max-width: 800px; margin: auto; }
  textarea { width: 100%; min-height: 150px; padding: 0.5em; font-size: 1em; }
  select, input, button { font-size: 1em; margin: 0.25em 0; }
  #generateBtn { background: #ff9800; color: white; padding: 1em; border: none; font-size: 1.2em; cursor: pointer; display: block; width: 100%; margin: 1em 0; }
  #generateBtn:hover { background: #e68a00; }
  .optional-section { border: 2px dashed #ccc; padding: 1em; margin-top: 1em; background: #fff; }
  .word { font-size: 2em; margin: 0.25em; display: inline-block; cursor: pointer; }
  .highlight { background: yellow; }
  .silent { color: gray; }
  .ph1 { color: #e91e63; }
  .ph2 { color: #9c27b0; }
  .ph3 { color: #3f51b5; }
  .ph4 { color: #03a9f4; }
  .ph5 { color: #009688; }
  .ph6 { color: #4caf50; }
  .paragraph { display: block; margin-bottom: 1em; }
  #reader { margin-top: 2em; }
</style>
</head>
<body>

<header>
  <h1>Reading Helper</h1>
</header>

<main>
  <label for="langSelect">Language:</label>
  <select id="langSelect">
    <option value="en">English</option>
    <option value="fr">FranÃ§ais</option>
  </select>

  <textarea id="story"></textarea>
  <button id="generateBtn">ðŸ”§ Generate Reading Helper</button>

  <div class="optional-section">
    <h3>Optional AI Features</h3>
    <label for="apiKey">OpenAI API Key:</label>
    <input type="text" id="apiKey" placeholder="sk-...">
    <button id="generateStoryBtn">Generate Story with AI</button>
  </div>

  <div id="reader"></div>
</main>

<script>
let PHONICS = {};
let storyWords = [];
let currentWordIndex = 0;
let voice = null;

function normalizeWord(w) {
  return w.toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, ""); // strip accents
}

async function loadPhonics(lang) {
  if (lang === 'en') {
    const mod = await import('./phonics-en.js');
    PHONICS = mod.PHONICS.en;
  } else if (lang === 'fr') {
    const mod = await import('./phonics-fr.js');
    PHONICS = mod.PHONICS.fr;
  }
}

function buildReader() {
  const reader = document.getElementById('reader');
  reader.innerHTML = '';
  const text = document.getElementById('story').value.trim();
  if (!text) return;

  // Split into paragraphs on sentence boundaries
  const paragraphs = text.split(/(?<=[.!?â€¦])\s+/);
  storyWords = [];

  paragraphs.forEach(p => {
    const paraEl = document.createElement('div');
    paraEl.className = 'paragraph';
    const words = p.split(/\s+/);
    words.forEach(w => {
      const span = document.createElement('span');
      span.className = 'word';
      span.innerHTML = applyPhonics(w);
      span.addEventListener('click', () => speakWord(w));
      storyWords.push(span);
      paraEl.appendChild(span);
    });
    reader.appendChild(paraEl);
  });

  highlightWord(0);
}

function applyPhonics(word) {
  let norm = normalizeWord(word);
  let chars = word.split('');

  // Silent letters by dictionary
  if (PHONICS.silentWords[norm]) {
    PHONICS.silentWords[norm].forEach(i => {
      if (chars[i]) chars[i] = `<span class="silent">${chars[i]}</span>`;
    });
  }

  let joined = chars.join('');

  // Apply colored phonics patterns
  PHONICS.colored.forEach(rule => {
    const regex = new RegExp(rule.match, 'gi');
    joined = joined.replace(regex, match => `<span class="${rule.cls}">${match}</span>`);
  });

  return joined;
}

function highlightWord(index) {
  storyWords.forEach((w, i) => w.classList.toggle('highlight', i === index));
  currentWordIndex = index;
}

function speakWord(word) {
  if (!word) return;
  const synth = window.speechSynthesis;
  const utter = new SpeechSynthesisUtterance(word.replace(/[^a-zA-ZÃ€-Ã¿']/g, ''));
  if (voice) utter.voice = voice;
  synth.cancel();
  synth.speak(utter);
  if (currentWordIndex < storyWords.length - 1) {
    highlightWord(currentWordIndex + 1);
  }
}

document.getElementById('generateBtn').addEventListener('click', buildReader);
document.getElementById('langSelect').addEventListener('change', async (e) => {
  await loadPhonics(e.target.value);
});

window.addEventListener('load', async () => {
  await loadPhonics('en');
  // Default example story
  const defaultStory = `The Unicorn and the Mermaid

Luna the unicorn trotted to the sea.
She met Mira the mermaid. "Hi!"
A tiny crab did a silly dance. Everyone giggled.
Luna made a sand cake with shiny shells on top.
The cake wobbled, but it looked yummy.
A little sea snail clapped from a rock.
A gull swooped by and splashed in the water.
They shared the cake. The crab had a tiny bite.
"It's delicious!" said Mira. Luna laughed.
They made shell crowns, then watched pink clouds.
"Best day," said Luna.
"See you tomorrow," said Mira. Friends for life.`;
  document.getElementById('story').value = defaultStory;

  // Preload a voice
  window.speechSynthesis.onvoiceschanged = () => {
    const voices = window.speechSynthesis.getVoices();
    voice = voices.find(v => v.lang.startsWith('en')) || voices[0];
  };
});
</script>
</body>
</html>