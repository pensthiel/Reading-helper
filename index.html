<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kids Reading Helper</title>
<style>
  :root{
    --bg:#ffffff;--fg:#111;--muted:#666;--accent:#2b8a3e;--danger:#c92a2a;--card:#f6f6f7;--highlight:#fff3bf
  }
  .dark{--bg:#0f1115;--fg:#f1f3f5;--muted:#9aa0a6;--accent:#7cd992;--danger:#ff6b6b;--card:#171a21;--highlight:#2a2e39}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  h1{font-size:22px;margin:8px 0}
  .card{background:var(--card);border-radius:12px;padding:12px;margin:10px 0}
  label{font-size:14px;color:var(--muted);display:block;margin:8px 0 4px}
  input[type="text"],input[type="password"],textarea,select{width:100%;box-sizing:border-box;padding:10px 12px;border-radius:10px;border:1px solid #0000;background:var(--bg);color:var(--fg)}
  textarea{min-height:140px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:720px){.row-2{grid-template-columns:1fr 1fr}.row-3{grid-template-columns:1fr 1fr 1fr}}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:9px 12px;border-radius:10px;border:1px solid #0000;background:var(--accent);color:#fff;cursor:pointer;font-weight:600;text-decoration:none;user-select:none}
  .btn.ghost{background:#0000;color:var(--fg);border:1px solid var(--muted)}
  .btn.secondary{background:#3b82f6}
  .btn.danger{background:var(--danger)}
  .btn.sm{padding:6px 10px;font-size:14px}
  .note{font-size:12px;color:var(--muted)}
  .error{color:var(--danger);font-weight:600}
  /* Reader layout */
  #reader{display:none;margin-top:8px;border-radius:12px}
  .reader-grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:900px){
    .reader-grid{grid-template-columns:300px 1fr;align-items:start}
    .reader-controls{position:sticky;top:8px;max-height:80vh;overflow:auto}
  }
  @media(max-width:899px){
    .reader-controls{position:sticky;top:0;z-index:5;background:var(--card);border-radius:12px;padding:8px}
  }
  .reader-controls{display:flex;flex-wrap:wrap;gap:6px;background:var(--card);border-radius:12px}
  .control-row{display:flex;flex-wrap:wrap;gap:6px;width:100%}
  .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:var(--bg);border:1px solid var(--muted)}
  .reader-inner{background:var(--card);border-radius:12px;padding:16px;font-size:clamp(22px,6vw,34px);line-height:1.9;letter-spacing:.4px;word-spacing:.25em;user-select:none;-webkit-tap-highlight-color:transparent}
  .word{padding:4px 6px;border-radius:6px;display:inline-block;margin:0 2px}
  .word.current{background:var(--highlight)}
  .hint{font-size:13px;background:#0008;color:#fff;padding:6px 10px;border-radius:999px;position:sticky;top:52px;align-self:flex-start;display:none}
  footer{margin:24px 0 40px;text-align:center;font-size:12px;color:var(--muted)}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;padding:2px 6px;border:1px solid var(--muted);border-radius:6px;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Kids Reading Helper</h1>
    <div>
      <button id="toggleTheme" class="btn ghost">üåô Theme</button>
    </div>
  </header>

  <!-- intro text -->
  <section class="card">
    <h2 style="margin:6px 0 8px;font-size:18px">What this does</h2>
    <p class="note" style="font-size:14px;color:var(--fg)">
      Paste a story or generate one with your GPT key, pick age or reading level, then build the helper.
      The reading view shows big text. The first word is highlighted. Tap or click anywhere to hear the next word.
      It advances one word per tap. You can also tap a word if sequence lock is off.
    </p>
  </section>

  <section class="card">
    <div class="row row-2">
      <div>
        <label for="story">Story text</label>
        <textarea id="story" placeholder="Paste or write your story here..."></textarea>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
          <button id="btnSaveStory" class="btn ghost sm">üíæ Save story</button>
          <button id="btnClearStory" class="btn ghost sm">üßπ Clear</button>
        </div>
      </div>
      <div>
        <label>Generate with GPT - optional</label>
        <input id="apiKey" type="password" placeholder="OpenAI API key" autocomplete="off" />
        <label for="prompt">Prompt</label>
        <input id="prompt" type="text" placeholder="Write a fun 150 word story about a friendly dragon" />
        <div class="row row-3">
          <div>
            <label for="mode">Age or reading level</label>
            <select id="mode"><option value="age" selected>Age</option><option value="level">Reading level</option></select>
          </div>
          <div id="ageWrap">
            <label for="age">Age</label>
            <select id="age"><option>4</option><option>5</option><option selected>6</option><option>7</option><option>8</option><option>9</option><option>10</option></select>
          </div>
          <div id="levelWrap" style="display:none">
            <label for="level">Level</label>
            <select id="level"><option selected>Beginner</option><option>Intermediate</option><option>Advanced</option></select>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap">
          <label style="display:inline-flex;align-items:center;gap:6px;font-size:13px"><input type="checkbox" id="rememberKey" /> remember key</label>
          <button id="btnGenerateGPT" class="btn secondary sm">ü§ñ Generate story</button>
        </div>
        <div class="note">Key is stored only if you tick remember.</div>
      </div>
    </div>
  </section>

  <section class="card">
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="btnBuildReader" class="btn">üîß Generate Reading Helper</button>
      <button id="btnStartOver" class="btn ghost sm">üîÅ Start over</button>
      <button id="btnResetAll" class="btn danger sm">‚ôªÔ∏è Reset all</button>
    </div>
    <div id="status" class="note" style="margin-top:6px"></div>

    <div id="reader" class="reader-grid">
      <div>
        <div class="reader-controls">
          <div class="control-row">
            <button id="btnPrev" class="btn ghost sm">‚óÄ Prev</button>
            <button id="btnSpeak" class="btn sm">üîä Speak</button>
            <button id="btnNext" class="btn ghost sm">Next ‚ñ∂</button>
            <span class="pill" id="progressPill">0 of 0</span>
          </div>
          <div class="control-row">
            <label class="pill" style="display:inline-flex;align-items:center;gap:6px">
              <input type="checkbox" id="enforceSeq" checked /> lock sequence
            </label>
            <label class="pill">rate <input type="range" id="rate" min="0.6" max="1.4" step="0.05" value="1"></label>
            <label class="pill">pitch <input type="range" id="pitch" min="0.8" max="1.4" step="0.05" value="1"></label>
            <label class="pill">voice <select id="voiceSelect"></select></label>
          </div>
          <div class="hint" id="tapHint">Tip: tap or click to hear the next word</div>
        </div>
      </div>

      <div class="reader-inner" id="readerText" aria-live="polite"></div>
    </div>
  </section>

  <footer>Client side only. Works on iPhone, iPad, desktop. Uses Web Speech API.</footer>
</div>

<script>
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const LS = {story:"krh_story",idx:"krh_index",theme:"krh_theme",key:"krh_key",settings:"krh_settings"};
  const state = {tokens:[],index:0,voices:[]};

  // Default example story for first load
  const DEFAULT_STORY = `The Unicorn and the Mermaid

Luna the unicorn trotted to the sea.
She met Mira the mermaid. "Hi!"
A tiny crab did a silly dance. Everyone giggled.
Luna made a sand cake with shiny shells on top.
The cake wobbled, but it looked yummy.
A little sea snail clapped from a rock.
A gull swooped by and splashed in the water.
They shared the cake. The crab had a tiny bite.
"It's delicious!" said Mira. Luna laughed.
They made shell crowns, then watched pink clouds.
"Best day," said Luna.
"See you tomorrow," said Mira. Friends for life.`;

  // theme
  if(localStorage.getItem(LS.theme)==="dark") document.documentElement.classList.add("dark");
  $("#toggleTheme").addEventListener("click",()=>{document.documentElement.classList.toggle("dark");localStorage.setItem(LS.theme,document.documentElement.classList.contains("dark")?"dark":"light");});

  // mode switch
  $("#mode").addEventListener("change",e=>{
    const v=e.target.value;
    $("#ageWrap").style.display=v==="age"?"":"none";
    $("#levelWrap").style.display=v==="level"?"":"none";
  });

  // boot
  (function(){
    let s = localStorage.getItem(LS.story);
    if (!s || !s.trim()) {
      s = DEFAULT_STORY;
      localStorage.setItem(LS.story, s);
    }
    $("#story").value = s;

    const st = JSON.parse(localStorage.getItem(LS.settings) || "{}");
    if(st.rate) $("#rate").value = st.rate;
    if(st.pitch) $("#pitch").value = st.pitch;
    if(st.enforceSeq !== undefined) $("#enforceSeq").checked = !!st.enforceSeq;

    const k = localStorage.getItem(LS.key);
    if (k) { $("#apiKey").value = k; $("#rememberKey").checked = true; }

    setStatus("Story ready. Tap Generate Reading Helper to start.");
  })();

  $("#btnSaveStory").addEventListener("click",()=>{localStorage.setItem(LS.story,$("#story").value.trim());setStatus("Story saved.");});
  $("#btnClearStory").addEventListener("click",()=>{$("#story").value="";setStatus("Cleared.");});

  $("#rememberKey").addEventListener("change",e=>{if(e.target.checked){localStorage.setItem(LS.key,$("#apiKey").value);}else{localStorage.removeItem(LS.key);}});
  $("#apiKey").addEventListener("input",()=>{$("#rememberKey").checked && localStorage.setItem(LS.key,$("#apiKey").value);});

  $("#btnGenerateGPT").addEventListener("click",async()=>{
    const key=$("#apiKey").value.trim(); if(!key) return setError("Enter API key.");
    const prompt=($("#prompt").value.trim()||"Write a simple 150 word story for a young child.");
    const mode=$("#mode").value, age=$("#age").value, level=$("#level").value;
    const guidance=mode==="age" ? `Target age ${age}. Short sentences. Simple vocabulary.` : `Reading level ${level}. Short sentences. Simple vocabulary.`;
    try{
      setStatus("Generating...");
      const body={model:"gpt-4o-mini",messages:[
        {role:"system",content:"You write child friendly stories with simple vocabulary and short sentences."},
        {role:"user",content:`${prompt}\n\nConstraints: ${guidance}\nLength: about 150 words.`}
      ],temperature:0.8};
      const res=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json","Authorization":`Bearer ${key}`},body:JSON.stringify(body)});
      if(!res.ok){throw new Error(await res.text());}
      const data=await res.json();
      const text=data.choices?.[0]?.message?.content?.trim(); if(!text) throw new Error("No text returned.");
      $("#story").value=text; localStorage.setItem(LS.story,text); setStatus("Story generated.");
    }catch(err){setError(err.message||String(err));}
  });

  $("#btnBuildReader").addEventListener("click",()=>{
    const text=($("#story").value||"").trim(); if(!text) return setError("Add or generate a story first.");
    buildReader(text);
    $("#reader").style.display="block";
    $("#reader").scrollIntoView({behavior:"smooth",block:"start"});
  });

  $("#btnStartOver").addEventListener("click",()=>{state.index=0;updateHighlight();saveProgress();speakCurrent(true);});
  $("#btnResetAll").addEventListener("click",()=>{if(!confirm("Reset everything"))return;localStorage.removeItem(LS.story);localStorage.removeItem(LS.idx);localStorage.removeItem(LS.settings);$("#story").value="";$("#readerText").innerHTML="";$("#reader").style.display="none";setStatus("All cleared.");});

  $("#btnPrev").addEventListener("click",()=>step(-1,true));
  $("#btnNext").addEventListener("click",()=>step(1,true));
  $("#btnSpeak").addEventListener("click",()=>speakCurrent(true));
  $("#rate").addEventListener("input",saveSettings);
  $("#pitch").addEventListener("input",saveSettings);
  $("#enforceSeq").addEventListener("change",saveSettings);
  $("#voiceSelect").addEventListener("change",saveSettings);

  window.addEventListener("keydown",e=>{
    if($("#reader").style.display!=="block")return;
    if(e.code==="Space"){e.preventDefault();step(1);}
    if(e.code==="ArrowRight"){e.preventDefault();step(1,true);}
    if(e.code==="ArrowLeft"){e.preventDefault();step(-1,true);}
  });

  function populateVoices(){
    if(!("speechSynthesis" in window)) return setError("No TTS support.");
    const sel=$("#voiceSelect"); sel.innerHTML="";
    const voices=speechSynthesis.getVoices().filter(v=>v.lang?.toLowerCase().startsWith("en"));
    state.voices=voices;
    voices.forEach((v,i)=>{const o=document.createElement("option");o.value=String(i);o.textContent=`${v.name} - ${v.lang}`;sel.appendChild(o);});
  }
  if("speechSynthesis" in window){speechSynthesis.onvoiceschanged=populateVoices; populateVoices();}

  function buildReader(text){
    localStorage.setItem(LS.story,text);
    state.tokens=tokenize(text);
    const container=$("#readerText"); container.innerHTML="";
    state.tokens.forEach((t,i)=>{const s=document.createElement("span");s.className="word";s.dataset.i=String(i);s.textContent=t.display;container.appendChild(s);container.append(" ");});
    const savedIdx=parseInt(localStorage.getItem(LS.idx)||"0",10);
    state.index=isNaN(savedIdx)?0:clamp(savedIdx,0,state.tokens.length-1);
    updateHighlight();

    container.onclick=(e)=>{
      const enforce=$("#enforceSeq").checked;
      $("#tapHint").style.display="none";
      if(!enforce){
        const w=e.target.closest(".word");
        if(w){state.index=clamp(parseInt(w.dataset.i,10),0,state.tokens.length-1);speakCurrent(true);updateHighlight();saveProgress();}
        return;
      }
      step(1);
    };
    $("#tapHint").style.display="inline-block";
    setStatus("Reader ready. Tap or click anywhere in the text.");
    $("#progressPill").textContent=`${state.index+1} of ${state.tokens.length}`;
  }

  function tokenize(text){
    const raw=text.split(/\s+/).filter(Boolean);
    return raw.map(w=>({display:w,speak:w.replace(/^[^A-Za-z0-9]+|[^A-Za-z0-9]+$/g,"")||w}));
  }

  function updateHighlight(){
    $$(".word").forEach(el=>el.classList.remove("current"));
    const el=$(`.word[data-i="${state.index}"]`);
    if(el) el.classList.add("current");
    $("#progressPill").textContent=`${state.index+1} of ${state.tokens.length}`;
    el?.scrollIntoView({block:"center",behavior:"smooth"});
  }

  function step(dir,manual=false){
    if(!state.tokens.length)return;
    speakCurrent(true,()=>{ 
      if(dir>=0){ 
        if(state.index<state.tokens.length-1) state.index++; 
      } else { 
        if(state.index>0) state.index--; 
      } 
      updateHighlight(); 
      saveProgress(); 
    });
  }

  function speakCurrent(interrupt=false,after=null){
    if(!("speechSynthesis" in window)) return setError("No TTS support.");
    const tok=state.tokens[state.index]; if(!tok) return;
    if(interrupt) speechSynthesis.cancel();
    const u=new SpeechSynthesisUtterance(tok.speak);
    u.rate=parseFloat($("#rate").value||"1"); 
    u.pitch=parseFloat($("#pitch").value||"1");
    const vi=parseInt($("#voiceSelect").value||"-1",10); 
    if(!isNaN(vi)&&state.voices[vi]) u.voice=state.voices[vi];
    u.onend=()=>after&&after(); 
    u.onerror=()=>setError("TTS failed.");
    speechSynthesis.speak(u);
  }

  function saveProgress(){localStorage.setItem(LS.idx,String(state.index));}
  function saveSettings(){localStorage.setItem(LS.settings,JSON.stringify({rate:$("#rate").value,pitch:$("#pitch").value,enforceSeq:$("#enforceSeq").checked,voice:$("#voiceSelect").value}));}
  function setStatus(m){const s=$("#status"); s.className="note"; s.textContent=m;}
  function setError(m){const s=$("#status"); s.className="note error"; s.textContent=m;}
  function clamp(n,min,max){return Math.max(min,Math.min(max,n));}

  // prevent iOS double tap zoom
  let lastTap=0; 
  document.addEventListener("touchend",e=>{const now=Date.now(); if(now-lastTap<350) e.preventDefault(); lastTap=now;},{passive:false});
</script>
</body>
</html>