<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kids Reading Helper</title>
<style>
  :root{
    --bg:#ffffff;--fg:#111;--muted:#666;--accent:#2b8a3e;--danger:#c92a2a;--card:#f6f6f7;--highlight:#fff3bf;
    --col1:#1f7a8c; --col2:#9c27b0; --col3:#ff7043; --col4:#2e7d32; --col5:#1565c0; --col6:#c2185b; --silent:#9aa0a6;
  }
  .dark{--bg:#0f1115;--fg:#f1f3f5;--muted:#9aa0a6;--accent:#7cd992;--danger:#ff6b6b;--card:#171a21;--highlight:#2a2e39;--silent:#6b7280}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  h1{font-size:22px;margin:8px 0}
  .card{background:var(--card);border-radius:12px;padding:12px;margin:10px 0}
  label{font-size:14px;color:var(--muted);display:block;margin:8px 0 4px}
  input[type="text"],input[type="password"],textarea,select{width:100%;box-sizing:border-box;padding:10px 12px;border-radius:10px;border:1px solid #0000;background:var(--bg);color:var(--fg)}
  textarea{min-height:140px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:720px){.row-2{grid-template-columns:1fr 1fr}.row-3{grid-template-columns:1fr 1fr 1fr}}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:9px 12px;border-radius:10px;border:1px solid #0000;background:var(--accent);color:#fff;cursor:pointer;font-weight:600;text-decoration:none;user-select:none}
  .btn.ghost{background:#0000;color:var(--fg);border:1px solid var(--muted)}
  .btn.secondary{background:#3b82f6}
  .btn.danger{background:var(--danger)}
  .btn.sm{padding:6px 10px;font-size:14px}
  .note{font-size:12px;color:var(--muted)}
  .error{color:var(--danger);font-weight:600}
  /* Reader layout */
  #reader{display:none;margin-top:8px;border-radius:12px}
  .reader-grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:900px){
    .reader-grid{grid-template-columns:320px 1fr;align-items:start}
    .reader-controls{position:sticky;top:8px;max-height:80vh;overflow:auto}
  }
  @media(max-width:899px){
    .reader-controls{position:sticky;top:0;z-index:5;background:var(--card);border-radius:12px;padding:8px}
  }
  .reader-controls{display:flex;flex-wrap:wrap;gap:6px;background:var(--card);border-radius:12px}
  .control-row{display:flex;flex-wrap:wrap;gap:6px;width:100%}
  .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:var(--bg);border:1px solid var(--muted)}
  .reader-inner{background:var(--card);border-radius:12px;padding:16px;font-size:clamp(22px,6vw,34px);line-height:2;letter-spacing:.4px;word-spacing:.25em;user-select:none;-webkit-tap-highlight-color:transparent}
  .reader-inner p{margin:0 0 1.2em 0}
  .reader-inner p.title{font-weight:800;margin-bottom:0.8em}
  .word{padding:4px 6px;border-radius:6px;display:inline-block;margin:0 2px}
  .word.current{background:var(--highlight)}
  .hint{font-size:13px;background:#0008;color:#fff;padding:6px 10px;border-radius:999px;position:sticky;top:52px;align-self:flex-start;display:none}
  .ph1{color:var(--col1)} .ph2{color:var(--col2)} .ph3{color:var(--col3)} .ph4{color:var(--col4)} .ph5{color:var(--col5)} .ph6{color:var(--col6)}
  .silent{color:var(--silent)}
  footer{margin:24px 0 40px;text-align:center;font-size:12px;color:var(--muted)}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;padding:2px 6px;border:1px solid var(--muted);border-radius:6px;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Kids Reading Helper</h1>
    <div>
      <button id="toggleTheme" class="btn ghost">üåô Theme</button>
    </div>
  </header>

  <!-- intro text -->
  <section class="card">
    <h2 style="margin:6px 0 8px;font-size:18px">What this does</h2>
    <p class="note" style="font-size:14px;color:var(--fg)">
      Paste a story or generate one with your GPT key, pick age or reading level, then build the helper.
      The reading view shows big text with real paragraph spacing. The first line is treated as a title and shown bold.
      Tap or click anywhere to hear the next word. It advances one word per tap. Phonics is highlighted automatically.
    </p>
  </section>

  <section class="card">
    <div class="row row-2">
      <div>
        <label for="story">Story text</label>
        <textarea id="story" placeholder="Paste or write your story here..."></textarea>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
          <button id="btnSaveStory" class="btn ghost sm">üíæ Save story</button>
          <button id="btnClearStory" class="btn ghost sm">üßπ Clear</button>
        </div>
      </div>
      <div>
        <label>Generate with GPT - optional</label>
        <input id="apiKey" type="password" placeholder="OpenAI API key" autocomplete="off" />
        <label for="prompt">Prompt</label>
        <input id="prompt" type="text" placeholder="Write a fun 150 word story about a friendly dragon" />
        <div class="row row-3">
          <div>
            <label for="mode">Age or reading level</label>
            <select id="mode"><option value="age" selected>Age</option><option value="level">Reading level</option></select>
          </div>
          <div id="ageWrap">
            <label for="age">Age</label>
            <select id="age"><option>4</option><option>5</option><option selected>6</option><option>7</option><option>8</option><option>9</option><option>10</option></select>
          </div>
          <div id="levelWrap" style="display:none">
            <label for="level">Level</label>
            <select id="level"><option selected>Beginner</option><option>Intermediate</option><option>Advanced</option></select>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap">
          <label style="display:inline-flex;align-items:center;gap:6px;font-size:13px"><input type="checkbox" id="rememberKey" /> remember key</label>
          <button id="btnGenerateGPT" class="btn secondary sm">ü§ñ Generate story</button>
        </div>
        <div class="note">Key is stored only if you tick remember.</div>
      </div>
    </div>
  </section>

  <section class="card">
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <button id="btnBuildReader" class="btn">üîß Generate Reading Helper</button>
      <button id="btnStartOver" class="btn ghost sm">üîÅ Start over</button>
      <button id="btnResetAll" class="btn danger sm">‚ôªÔ∏è Reset all</button>
      <span class="pill" style="margin-left:auto">
        Language
        <select id="langSelect" style="margin-left:6px">
          <option value="en" selected>English</option>
          <option value="fr">Fran√ßais</option>
          <option value="es">Espa√±ol</option>
        </select>
      </span>
    </div>
    <div id="status" class="note" style="margin-top:6px"></div>

    <div id="reader" class="reader-grid">
      <div>
        <div class="reader-controls">
          <div class="control-row">
            <button id="btnPrev" class="btn ghost sm">‚óÄ Prev</button>
            <button id="btnSpeak" class="btn sm">üîä Speak</button>
            <button id="btnNext" class="btn ghost sm">Next ‚ñ∂</button>
            <span class="pill" id="progressPill">0 of 0</span>
          </div>
          <div class="control-row">
            <label class="pill" style="display:inline-flex;align-items:center;gap:6px">
              <input type="checkbox" id="enforceSeq" checked /> lock sequence
            </label>
            <label class="pill">rate <input type="range" id="rate" min="0.6" max="1.4" step="0.05" value="1"></label>
            <label class="pill">pitch <input type="range" id="pitch" min="0.8" max="1.4" step="0.05" value="1"></label>
            <label class="pill">voice <select id="voiceSelect"></select></label>
          </div>
          <div class="hint" id="tapHint">Tip: tap or click to hear the next word</div>
        </div>
      </div>

      <div class="reader-inner" id="readerText" aria-live="polite"></div>
    </div>
  </section>

  <footer>Client side only. Works on iPhone, iPad, desktop. Uses Web Speech API.</footer>
</div>

<script>
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const LS = {story:"krh_story",idx:"krh_index",theme:"krh_theme",key:"krh_key",settings:"krh_settings",lang:"krh_lang"};
  const state = {tokens:[],index:0,voices:[],lang:"en"};

  // Default example story for first load
  const DEFAULT_STORY = `The Unicorn and the Mermaid

The Unicorn and the Mermaid
Luna the unicorn trotted to the sea.
She met Mira the mermaid. "Hi!"
A tiny crab did a silly dance. Everyone giggled.
Luna made a sand cake with shiny shells on top.
The cake wobbled, but it looked yummy.
A little sea snail clapped from a rock.
A gull swooped by and splashed in the water.
They shared the cake. The crab had a tiny bite.
"It's delicious!" said Mira. Luna laughed.
They made shell crowns, then watched pink clouds.
"Best day," said Luna.
"See you tomorrow," said Mira. Friends for life.`;

  /* ---------------- Phonics rules (simple, helpful, not exhaustive) ---------------- */
  const PHONICS = {
    en: {
      colored: [
        {re:/oo/gi, cls:'ph1'}, {re:/ou/gi, cls:'ph2'}, {re:/ee/gi, cls:'ph3'},
        {re:/th/gi, cls:'ph4'}, {re:/sh/gi, cls:'ph5'}, {re:/ch/gi, cls:'ph6'},
        {re:/ai/gi, cls:'ph1'}, {re:/oa/gi, cls:'ph2'}, {re:/ow/gi, cls:'ph3'}
      ],
      silent: [
        // final silent e
        {re:/e\b/gi},
        // kn- -> silent k
        {re:/\bk(?=n)/gi},
        // wr- -> silent w
        {re:/\bw(?=r)/gi},
        // -mb end -> silent b
        {re:/b\b(?<=m b?)/gi}, // tolerant
        // gh often silent at end or before t
        {re:/gh\b/gi},
        {re:/gh(?=t)/gi}
      ]
    },
    fr: {
      colored: [
        {re:/ou/gi, cls:'ph1'}, {re:/on/gi, cls:'ph2'}, {re:/an/gi, cls:'ph3'},
        {re:/en/gi, cls:'ph3'}, {re:/in/gi, cls:'ph4'}, {re:/ai/gi, cls:'ph5'},
        {re:/eau/gi, cls:'ph6'}, {re:/au/gi, cls:'ph1'}, {re:/eu/gi, cls:'ph2'},
        {re:/oi/gi, cls:'ph4'}, {re:/ch/gi, cls:'ph5'}, {re:/gn/gi, cls:'ph6'},
        {re:/ill/gi, cls:'ph3'}
      ],
      silent: [
        // mute h
        {re:/h/gi},
        // final mute e
        {re:/e\b/gi},
        // common final silent consonants: s, x, t (not always, but helpful)
        {re:/[sxt]\b/gi},
        // verb -ent ending (often mute)
        {re:/ent\b/gi}
      ]
    },
    es: {
      colored: [
        {re:/ll/gi, cls:'ph1'}, {re:/rr/gi, cls:'ph2'}, {re:/ch/gi, cls:'ph3'},
        {re:/√±/gi, cls:'ph4'}, {re:/gue/gi, cls:'ph5'}, {re:/gui/gi, cls:'ph6'},
        {re:/que/gi, cls:'ph5'}, {re:/qui/gi, cls:'ph6'}
      ],
      silent: [
        // silent h
        {re:/h/gi},
        // silent 'u' in gue/gui/que/qui (not √º)
        {re:/(g|q)u(?=[ei])/gi}
      ]
    }
  };

  // theme
  if(localStorage.getItem(LS.theme)==="dark") document.documentElement.classList.add("dark");
  $("#toggleTheme").addEventListener("click",()=>{document.documentElement.classList.toggle("dark");localStorage.setItem(LS.theme,document.documentElement.classList.contains("dark")?"dark":"light");});

  // language selector
  (function initLang(){
    const saved = localStorage.getItem(LS.lang);
    state.lang = saved || "en";
    $("#langSelect").value = state.lang;
    $("#langSelect").addEventListener("change", ()=>{
      state.lang = $("#langSelect").value || "en";
      localStorage.setItem(LS.lang, state.lang);
      // rebuild highlighting if reader is visible
      if ($("#reader").style.display === "block") {
        const text = ($("#story").value || "").trim();
        if (text) buildReader(text, true);
      }
    });
  })();

  // mode switch
  $("#mode").addEventListener("change",e=>{
    const v=e.target.value;
    $("#ageWrap").style.display=v==="age"?"":"none";
    $("#levelWrap").style.display=v==="level"?"":"none";
  });

  // boot
  (function(){
    let s = localStorage.getItem(LS.story);
    if (!s || !s.trim()) {
      s = DEFAULT_STORY;
      localStorage.setItem(LS.story, s);
    }
    $("#story").value = s;

    const st = JSON.parse(localStorage.getItem(LS.settings) || "{}");
    if(st.rate) $("#rate").value = st.rate;
    if(st.pitch) $("#pitch").value = st.pitch;
    if(st.enforceSeq !== undefined) $("#enforceSeq").checked = !!st.enforceSeq;
    if (st.voice) $("#voiceSelect").value = st.voice;

    const k = localStorage.getItem(LS.key);
    if (k) { $("#apiKey").value = k; $("#rememberKey").checked = true; }

    setStatus("Story ready. Tap Generate Reading Helper to start.");
  })();

  $("#btnSaveStory").addEventListener("click",()=>{localStorage.setItem(LS.story,$("#story").value.trim());setStatus("Story saved.");});
  $("#btnClearStory").addEventListener("click",()=>{$("#story").value="";setStatus("Cleared.");});

  $("#rememberKey").addEventListener("change",e=>{if(e.target.checked){localStorage.setItem(LS.key,$("#apiKey").value);}else{localStorage.removeItem(LS.key);}});
  $("#apiKey").addEventListener("input",()=>{$("#rememberKey").checked && localStorage.setItem(LS.key,$("#apiKey").value);});

  $("#btnGenerateGPT").addEventListener("click",async()=>{
    const key=$("#apiKey").value.trim(); if(!key) return setError("Enter API key.");
    const prompt=($("#prompt").value.trim()||"Write a simple 150 word story for a young child.");
    const mode=$("#mode").value, age=$("#age").value, level=$("#level").value, lang = $("#langSelect").value || "en";
    const guidance=mode==="age" ? `Target age ${age}. Short sentences. Simple vocabulary.` : `Reading level ${level}. Short sentences. Simple vocabulary.`;
    const langNote = lang === "fr" ? "Write in French." : lang === "es" ? "Write in Spanish." : "Write in English.";
    try{
      setStatus("Generating...");
      const body={model:"gpt-4o-mini",messages:[
        {role:"system",content:"You write child friendly stories with simple vocabulary and short sentences."},
        {role:"user",content:`${langNote}\n${prompt}\n\nConstraints: ${guidance}\nLength: about 150 words.`}
      ],temperature:0.8};
      const res=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json","Authorization":`Bearer ${key}`},body:JSON.stringify(body)});
      if(!res.ok){throw new Error(await res.text());}
      const data=await res.json();
      const text=data.choices?.[0]?.message?.content?.trim(); if(!text) throw new Error("No text returned.");
      $("#story").value=text; localStorage.setItem(LS.story,text); setStatus("Story generated.");
    }catch(err){setError(err.message||String(err));}
  });

  $("#btnBuildReader").addEventListener("click",()=>{
    const text=($("#story").value||"").trim(); if(!text) return setError("Add or generate a story first.");
    buildReader(text);
    $("#reader").style.display="block";
    $("#reader").scrollIntoView({behavior:"smooth",block:"start"});
  });

  $("#btnStartOver").addEventListener("click",()=>{state.index=0;updateHighlight();saveProgress();speakCurrent(true);});
  $("#btnResetAll").addEventListener("click",()=>{if(!confirm("Reset everything"))return;localStorage.removeItem(LS.story);localStorage.removeItem(LS.idx);localStorage.removeItem(LS.settings);$("#story").value="";$("#readerText").innerHTML="";$("#reader").style.display="none";setStatus("All cleared.");});

  $("#btnPrev").addEventListener("click",()=>step(-1,true));
  $("#btnNext").addEventListener("click",()=>step(1,true));
  $("#btnSpeak").addEventListener("click",()=>speakCurrent(true));
  $("#rate").addEventListener("input",saveSettings);
  $("#pitch").addEventListener("input",saveSettings);
  $("#enforceSeq").addEventListener("change",saveSettings);
  $("#voiceSelect").addEventListener("change",saveSettings);

  window.addEventListener("keydown",e=>{
    if($("#reader").style.display!=="block")return;
    if(e.code==="Space"){e.preventDefault();step(1);}
    if(e.code==="ArrowRight"){e.preventDefault();step(1,true);}
    if(e.code==="ArrowLeft"){e.preventDefault();step(-1,true);}
  });

  function populateVoices(){
    if(!("speechSynthesis" in window)) return setError("No TTS support.");
    const sel=$("#voiceSelect"); sel.innerHTML="";
    const voices=speechSynthesis.getVoices().filter(v=>v.lang); // allow all, device decides
    state.voices=voices;
    voices.forEach((v,i)=>{const o=document.createElement("option");o.value=String(i);o.textContent=`${v.name} - ${v.lang}`;sel.appendChild(o);});
  }
  if("speechSynthesis" in window){speechSynthesis.onvoiceschanged=populateVoices; populateVoices();}

  // Build reader with paragraphs, title, and phonics markup
  function buildReader(text, keepIndex=false){
    localStorage.setItem(LS.story,text);
    const container=$("#readerText"); container.innerHTML="";
    const paras = splitParagraphs(text);
    const tokens = [];
    let globalIndex = 0;

    paras.forEach((para, pi)=>{
      if (!para.trim()) return;
      const p = document.createElement("p");
      const isTitle = (pi===0 && maybeTitle(para));
      if (isTitle) p.classList.add("title");

      const words = para.split(/\s+/).filter(Boolean);
      words.forEach((raw,i)=>{
        const display = raw;
        const speak = stripPunct(raw);
        const wordSpan = document.createElement("span");
        wordSpan.className = "word";
        wordSpan.dataset.i = String(globalIndex);
        wordSpan.innerHTML = phonicsMarkup(display, state.lang); // inner pieces colored
        p.appendChild(wordSpan);
        p.append(" ");
        tokens.push({display, speak});
        globalIndex++;
      });
      container.appendChild(p);
    });

    state.tokens = tokens;

    const savedIdx=parseInt(localStorage.getItem(LS.idx)||"0",10);
    state.index = keepIndex ? clamp(savedIdx,0,state.tokens.length-1) : (isNaN(savedIdx) ? 0 : clamp(savedIdx,0,state.tokens.length-1));
    updateHighlight();

    container.onclick=(e)=>{
      const enforce=$("#enforceSeq").checked;
      $("#tapHint").style.display="none";
      const target = e.target.closest(".word");
      if(!enforce){
        if(target){state.index=clamp(parseInt(target.dataset.i,10),0,state.tokens.length-1);speakCurrent(true);updateHighlight();saveProgress();}
        return;
      }
      // sequence mode: any click advances current word
      step(1);
    };

    $("#tapHint").style.display="inline-block";
    setStatus("Reader ready. Tap or click anywhere in the text.");
    $("#progressPill").textContent=`${state.index+1} of ${state.tokens.length}`;
  }

  function splitParagraphs(text){
    // Split by blank lines, keep single newlines inside a paragraph
    return text.replace(/\r/g,'').split(/\n\s*\n/);
  }
  function maybeTitle(para){
    // Treat first line as title if short and ends without a period
    const firstLine = para.split('\n')[0].trim();
    return firstLine.length <= 60 && !/[.!?‚Ä¶]$/.test(firstLine);
  }

  function stripPunct(w){ return w.replace(/^[^\p{L}\p{N}]+|[^\p{L}\p{N}]+$/gu,""); }

  function phonicsMarkup(word, lang){
    const rules = PHONICS[lang] || PHONICS.en;
    // Work on the core letters, but keep leading/trailing punctuation around
    const leading = (word.match(/^[^\p{L}\p{N}]+/u)||[""])[0];
    const trailing = (word.match(/[^\p{L}\p{N}]+$/u)||[""])[0];
    let core = word.slice(leading.length, word.length - trailing.length);

    if (!core) return escapeHtml(word);

    // Build a map of segments with tags. We'll convert by walking left->right
    // 1) mark silent pieces first to avoid double-coloring
    let html = core;
    // wrap with temporary markers to avoid nested replacements interfering
    const wrap = (txt, cls) => `<span class="${cls}">${txt}</span>`;

    // Silent letters (gray)
    rules.silent.forEach(rule=>{
      html = html.replace(rule.re, (m)=>wrap(m, 'silent'));
    });

    // Colored digraphs/trigraphs
    rules.colored.forEach(rule=>{
      html = html.replace(rule.re, (m)=>wrap(m, rule.cls));
    });

    // Return with punctuation reattached
    return escapeHtml(leading) + html + escapeHtml(trailing);
  }

  function escapeHtml(s){ return s.replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }

  function updateHighlight(){
    $$(".word").forEach(el=>el.classList.remove("current"));
    const el=$(`.word[data-i="${state.index}"]`);
    if(el) el.classList.add("current");
    $("#progressPill").textContent=`${state.index+1} of ${state.tokens.length}`;
    el?.scrollIntoView({block:"center",behavior:"smooth"});
  }

  function step(dir){
    if(!state.tokens.length)return;
    speakCurrent(true,()=>{ 
      if(dir>=0){ if(state.index<state.tokens.length-1) state.index++; }
      else { if(state.index>0) state.index--; }
      updateHighlight(); 
      saveProgress(); 
    });
  }

  function speakCurrent(interrupt=false,after=null){
    if(!("speechSynthesis" in window)) return setError("No TTS support.");
    const tok=state.tokens[state.index]; if(!tok) return;
    if(interrupt) speechSynthesis.cancel();
    const u=new SpeechSynthesisUtterance(tok.speak);
    u.rate=parseFloat($("#rate").value||"1"); 
    u.pitch=parseFloat($("#pitch").value||"1");

    // pick voice by language preference if available
    const preferredLang = state.lang === "fr" ? "fr" : state.lang === "es" ? "es" : "en";
    const match = state.voices.find(v => v.lang && v.lang.toLowerCase().startsWith(preferredLang));
    const vi=parseInt($("#voiceSelect").value||"-1",10);
    if(!isNaN(vi) && state.voices[vi]) u.voice=state.voices[vi];
    else if (match) u.voice = match;

    u.onend=()=>after&&after(); 
    u.onerror=()=>setError("TTS failed.");
    speechSynthesis.speak(u);
  }

  function saveProgress(){localStorage.setItem(LS.idx,String(state.index));}
  function saveSettings(){localStorage.setItem(LS.settings,JSON.stringify({rate:$("#rate").value,pitch:$("#pitch").value,enforceSeq:$("#enforceSeq").checked,voice:$("#voiceSelect").value}));}
  function setStatus(m){const s=$("#status"); s.className="note"; s.textContent=m;}
  function setError(m){const s=$("#status"); s.className="note error"; s.textContent=m;}
  function clamp(n,min,max){return Math.max(min,Math.min(max,n));}

  // prevent iOS double tap zoom
  let lastTap=0; 
  document.addEventListener("touchend",e=>{const now=Date.now(); if(now-lastTap<350) e.preventDefault(); lastTap=now;},{passive:false});
</script>
</body>
</html>